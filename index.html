<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>سوبر ماركت أولاد يحيى — دفتر الحسابات</title>

  <link rel="stylesheet" href="./style.css" />
</head>

<body>

  <!-- ✅ PIN Gate -->
  <section id="pinGate" class="gate">
    <div class="gateCard">
      <div class="gateBrand">
        <div class="logo">OY</div>
        <div>
          <div class="title">سوبر ماركت أولاد يحيى</div>
          <div class="muted">دفتر الحسابات — دخول الإدارة</div>
        </div>
      </div>

      <form id="pinForm" class="gateForm">
        <label class="field">
          <span>PIN</span>
          <div class="pinRow">
            <input id="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="••••" />
            <button id="pinToggle" type="button" class="btn small ghost">إظهار</button>
          </div>
          <div id="pinError" class="error" hidden>PIN غير صحيح.</div>
        </label>

        <button class="btn primary" type="submit">دخول</button>
      </form>

      <div class="gateHint muted">
        لو نسيت الـ PIN راجع مسؤول النظام.
      </div>
    </div>
  </section>

  <!-- ✅ Top Nav -->
  <nav id="navBar" class="nav" hidden>
    <div class="navInner">
      <div class="navLeft">
        <div class="navBrand">
          <div class="logo small">OY</div>
          <div>
            <div class="navTitle">دفتر الحسابات</div>
            <div class="navSub muted">سوبر ماركت أولاد يحيى</div>
          </div>
        </div>
      </div>

      <div class="navRight">
        <button class="btn small ghost" id="btnPrint" type="button">طباعة / PDF</button>
        <button class="btn small danger" id="btnLogout" type="button">خروج</button>
      </div>
    </div>

    <div class="navTabs">
      <button class="navBtn active" data-page="dashboard" type="button">لوحة التحكم</button>
      <button class="navBtn" data-page="records" type="button">العمليات</button>
      <button class="navBtn" data-page="payments" type="button">المدفوعات</button>
      <button class="navBtn" data-page="ledger" type="button">كشف حساب</button>
      <button class="navBtn" data-page="reports" type="button">تقارير</button>
      <button class="navBtn" data-page="trash" type="button">المحذوفات</button>
    </div>
  </nav>

  <!-- ✅ App Root -->
  <main id="appRoot" class="app" hidden>

    <!-- ===================== DASHBOARD ===================== -->
    <section id="page-dashboard" class="page">
      <header class="pageHead">
        <h1>لوحة التحكم</h1>
        <p class="muted">ملخص سريع للحركة المالية</p>
      </header>

      <div class="kpis">
        <div class="kpi">
          <div class="kpiLabel">إجمالي المصروفات</div>
          <div class="kpiValue" id="kpiExpenses">0.00</div>
        </div>

        <div class="kpi">
          <div class="kpiLabel">إجمالي المدفوعات الخارجة</div>
          <div class="kpiValue" id="kpiPaid">0.00</div>
        </div>

        <div class="kpi">
          <div class="kpiLabel">المتبقي (فلوس ليا)</div>
          <div class="kpiValue" id="kpiReceivable">0.00</div>
        </div>

        <div class="kpi">
          <div class="kpiLabel">المتبقي (فلوس عليا)</div>
          <div class="kpiValue" id="kpiPayable">0.00</div>
        </div>

        <div class="kpi">
          <div class="kpiLabel">عدد العمليات</div>
          <div class="kpiValue" id="kpiCount">0</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>إضافة عملية جديدة</h2>
          <p class="muted">سجل عملية ثم أضف دفعات لاحقًا أو دفعة أولى</p>
        </div>

        <form id="entryForm" class="gridForm">
          <label class="field">
            <span>التاريخ</span>
            <input id="date" type="date" />
          </label>

          <label class="field">
            <span>النوع</span>
            <select id="type">
              <option value="">اختر…</option>
              <option value="expense">مصروف</option>
              <option value="advance">سُلفة</option>
              <option value="credit_customer">آجل (عميل)</option>
              <option value="credit_supplier">فاتورة/مورد</option>
            </select>
          </label>

          <label class="field">
            <span>الاسم/الجهة</span>
            <input id="party" type="text" placeholder="مثال: أحمد / مورد فلان" />
          </label>

          <label class="field">
            <span>الوصف</span>
            <input id="desc" type="text" placeholder="مثال: فاتورة بضاعة / سُلفة" />
          </label>

          <label class="field">
            <span>تصنيف المصروف</span>
            <select id="category">
              <option value="">— (للمصروف فقط)</option>
              <option value="إيجار">إيجار</option>
              <option value="كهرباء">كهرباء</option>
              <option value="مياه">مياه</option>
              <option value="مرتبات">مرتبات</option>
              <option value="نثريات">نثريات</option>
              <option value="أخرى">أخرى</option>
            </select>
          </label>

          <label class="field">
            <span>الإجمالي</span>
            <input id="total" type="number" inputmode="decimal" placeholder="0" />
          </label>

          <label class="field">
            <span>دفعة أولى (اختياري)</span>
            <input id="firstPay" type="number" inputmode="decimal" placeholder="0" />
            <div class="help">لن تظهر للمصروف. وتُسجَّل كدفعة مرتبطة بالعملية.</div>
          </label>

          <label class="field full">
            <span>ملاحظات</span>
            <textarea id="notes" rows="2" placeholder="أي تفاصيل إضافية…"></textarea>
          </label>

          <div class="actions full">
            <button class="btn primary" type="submit">حفظ العملية</button>
            <button class="btn ghost" id="btnReset" type="button">مسح</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ===================== RECORDS ===================== -->
    <section id="page-records" class="page" hidden>
      <header class="pageHead">
        <h1>العمليات</h1>
        <p class="muted">بحث + فلاتر سريعة (من الكاش — بدون تحميل الشيت كل مرة)</p>
      </header>

      <div class="filters">
        <input id="q" type="search" placeholder="بحث بالاسم/الوصف/الملاحظات…" />
        <select id="filterType">
          <option value="">كل الأنواع</option>
          <option value="expense">مصروف</option>
          <option value="advance">سُلفة</option>
          <option value="credit_customer">آجل (عميل)</option>
          <option value="credit_supplier">فاتورة/مورد</option>
        </select>
        <select id="filterOpen">
          <option value="">الكل</option>
          <option value="open">مفتوح</option>
          <option value="closed">مقفول</option>
        </select>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>النوع</th>
              <th>الجهة</th>
              <th>الوصف</th>
              <th>التصنيف</th>
              <th class="num">الإجمالي</th>
              <th class="num">المدفوع</th>
              <th class="num">المتبقي</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ===================== PAYMENTS ===================== -->
    <section id="page-payments" class="page" hidden>
      <header class="pageHead">
        <h1>المدفوعات</h1>
        <p class="muted">كل الدفعات (داخلة/خارجة) مرتبطة بكل عملية</p>
      </header>

      <div class="filters">
        <input id="payQ" type="search" placeholder="بحث بالاسم/الملاحظة/الاتجاه…" />
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>الاسم/الجهة</th>
              <th>المرجع</th>
              <th class="num">المبلغ</th>
              <th>ملاحظة</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="payTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ===================== LEDGER ===================== -->
    <section id="page-ledger" class="page" hidden>
      <header class="pageHead">
        <h1>كشف حساب</h1>
        <p class="muted">اكتب اسم شخص وسيظهر كشف الحساب + معاينة للطباعة</p>
      </header>

      <div class="filters">
        <input id="ledgerName" type="search" placeholder="اكتب الاسم…" />
        <select id="ledgerMode">
          <option value="all">الكل</option>
          <option value="customer">عملاء فقط (فلوس ليا)</option>
          <option value="supplier">موردين فقط (فلوس عليا)</option>
        </select>
        <button id="btnLedger" class="btn" type="button">عرض</button>
        <button id="btnLedgerPreview" class="btn ghost" type="button">معاينة</button>
      </div>

      <div id="ledgerBox" class="card"></div>
    </section>

    <!-- ===================== REPORTS ===================== -->
    <section id="page-reports" class="page" hidden>
      <header class="pageHead">
        <h1>التقارير</h1>
        <p class="muted">نطاقات زمنية + نوع تقرير + بحث بالجهة</p>
      </header>

      <div class="card">
        <div class="gridForm">
          <label class="field">
            <span>نطاق جاهز</span>
            <select id="repRangePreset">
              <option value="custom">مخصص</option>
              <option value="today">اليوم</option>
              <option value="last_7">آخر 7 أيام</option>
              <option value="last_30">آخر 30 يوم</option>
              <option value="this_month">هذا الشهر</option>
              <option value="this_year">هذا العام</option>
            </select>
          </label>

          <label class="field">
            <span>من</span>
            <input id="repFrom" type="date" />
          </label>

          <label class="field">
            <span>إلى</span>
            <input id="repTo" type="date" />
          </label>

          <label class="field">
            <span>نوع التقرير</span>
            <select id="repType">
              <option value="all">كل العمليات</option>
              <option value="expense">مصروف</option>
              <option value="advance">سُلفة</option>
              <option value="credit_customer">آجل (عميل)</option>
              <option value="credit_supplier">فاتورة/مورد</option>
              <option value="payments_out">مدفوعات خارجة فقط</option>
              <option value="receipts_in">متحصلات داخلة فقط</option>
            </select>
          </label>

          <label class="field">
            <span>بحث بالجهة</span>
            <input id="repParty" type="search" placeholder="اسم/وصف/ملاحظات…" />
          </label>

          <div class="actions full">
            <button id="btnRunReports" class="btn primary" type="button">تشغيل</button>
            <button id="btnPrintReports" class="btn ghost" type="button">طباعة التقرير</button>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="kpiLabel">عدد العمليات</div>
          <div class="kpiValue" id="repKpiEntries">0</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">إجمالي المدفوعات</div>
          <div class="kpiValue" id="repKpiPays">0.00</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">فلوس ليا (متبقي)</div>
          <div class="kpiValue" id="repKpiReceivable">0.00</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">فلوس عليا (متبقي)</div>
          <div class="kpiValue" id="repKpiPayable">0.00</div>
        </div>
      </div>

      <div class="card">
        <h2>العمليات</h2>
        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>النوع</th>
                <th>الجهة</th>
                <th>الوصف</th>
                <th class="num">الإجمالي</th>
                <th class="num">المدفوع</th>
                <th class="num">المتبقي</th>
              </tr>
            </thead>
            <tbody id="repEntriesTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>المدفوعات</h2>
        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>الجهة</th>
                <th>التفاصيل</th>
                <th class="num">المبلغ</th>
              </tr>
            </thead>
            <tbody id="repPaysTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== ENTRY PREVIEW ===================== -->
    <section id="page-entryPreview" class="page" hidden>
      <header class="pageHead">
        <h1>معاينة عملية</h1>
        <p class="muted" id="prevEntryMeta">—</p>
      </header>

      <div class="card">
        <div class="line"><span id="prevEntryStatus">—</span></div>
        <hr class="sep" />

        <div class="kv">
          <div><span>التاريخ</span><b id="prevDate">—</b></div>
          <div><span>النوع</span><b id="prevType">—</b></div>
          <div><span>الجهة</span><b id="prevParty">—</b></div>
          <div><span>الوصف</span><b id="prevDesc">—</b></div>
          <div><span>التصنيف</span><b id="prevCat">—</b></div>
          <div><span>ملاحظات</span><b id="prevNotes">—</b></div>
          <div><span>الإجمالي</span><b id="prevTotal">—</b></div>
          <div><span>مدفوع / متبقي</span><b id="prevPaidRemain">—</b></div>
        </div>

        <h3 style="margin-top:14px">مدفوعات العملية</h3>
        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>التفاصيل</th>
                <th class="num">المبلغ</th>
              </tr>
            </thead>
            <tbody id="prevPaysTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== LEDGER PREVIEW ===================== -->
    <section id="page-ledgerPreview" class="page" hidden>
      <header class="pageHead">
        <h1>معاينة كشف الحساب</h1>
        <p class="muted" id="prevLedgerMeta">—</p>
        <p class="muted" id="prevLedgerSummary">—</p>
      </header>

      <div class="card">
        <h2>العمليات</h2>
        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>النوع</th>
                <th>الوصف</th>
                <th class="num">الإجمالي</th>
                <th class="num">المدفوع</th>
                <th class="num">المتبقي</th>
              </tr>
            </thead>
            <tbody id="prevLedgerEntriesTbody"></tbody>
          </table>
        </div>

        <h2 style="margin-top:14px">المدفوعات</h2>
        <div class="tableWrap">
          <table class="table">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>التفاصيل</th>
                <th class="num">المبلغ</th>
              </tr>
            </thead>
            <tbody id="prevLedgerPaysTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===================== TRASH ===================== -->
    <section id="page-trash" class="page" hidden>
      <header class="pageHead">
        <h1>سجل المحذوفات</h1>
        <p class="muted">حذف نهائي بس بـ PIN</p>
      </header>

      <div class="filters">
        <input id="trashQ" type="search" placeholder="بحث في المحذوفات…" />
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>التوقيت</th>
              <th>النوع</th>
              <th>الجهة</th>
              <th class="num">المبلغ</th>
              <th>تفاصيل</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="trashTbody"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- ===================== PAY MODAL ===================== -->
  <div id="payModal" class="modal" hidden>
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <div class="modalTitle">إضافة دفعة</div>
          <div class="muted">ستُسجَّل على الشيت + كاش محلي</div>
        </div>
        <button id="payClose" class="btn small ghost" type="button">إغلاق</button>
      </div>

      <div class="modalBody">
        <label class="field">
          <span>تاريخ الدفعة</span>
          <input id="payDate" type="date" />
        </label>

        <label class="field">
          <span>المبلغ</span>
          <input id="payAmount" type="number" inputmode="decimal" placeholder="0" />
        </label>

        <label class="field">
          <span>ملاحظة</span>
          <input id="payNote" type="text" placeholder="مثال: جزء من الحساب" />
        </label>

        <div id="payError" class="error" hidden>من فضلك اكتب تاريخ + مبلغ صحيح.</div>

        <button id="paySave" class="btn primary" type="button">حفظ الدفعة</button>
      </div>
    </div>
  </div>

  <!-- ✅ API Config -->
  <script>
    window.AXENTRO_API = {
      // ✅ نفس لينك الـ Web App (Apps Script)
      scriptUrl: "https://script.google.com/macros/s/AKfycbyrekHgMhE1XIVv72XNS4C1WScMR4suihK74RoA7OHsmtBw2eNaGtoUGx7NkysF7YzU7g/exec",
      // ✅ لازم يطابق PIN في Code.gs و app.js
      pin: "1234"
    };
  </script>

  <script src="./app.js"></script>
</body>
</html>
